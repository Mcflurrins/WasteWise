stages:
  - comp3900-video
  - comp3900-checks
  - comp3900-build

variables:
  ASSIGNMENT_DOCUMENT_NAME: 'project-documentation'
  ASSIGNMENT_MIN_WORDS: 400
  ASSIGNMENT_MAX_WORDS: 1980
  ASSIGNMENT_VIDEO_NAME: 'project-presentation'
  ASSIGNMENT_VIDEO_MIN_DURATION: 30  # in seconds
  ASSIGNMENT_VIDEO_MAX_DURATION: 330  # in seconds

check_video_exists:
  stage: comp3900-video
  tags:
    - comp4350
  image: alpine:3.21.2
  script:
    # Check if the file exists
    - |
      if [ -f "$ASSIGNMENT_VIDEO_NAME.mp4" ]; then
        FILE_NAME="$ASSIGNMENT_VIDEO_NAME.mp4"
        echo "Found MP4 file: $FILE_NAME"
      else
        echo "Error: $ASSIGNMENT_VIDEO_NAME.mp4 found"
        exit 1
      fi  
  allow_failure: false

check_video_length:
  stage: comp3900-video
  tags:
    - comp4350
  image: 
    name: jrottenberg/ffmpeg:7.1-alpine
    entrypoint: [""] 
  variables:
    MIN_LENGTH: $ASSIGNMENT_VIDEO_MIN_DURATION
    MAX_LENGTH: $ASSIGNMENT_VIDEO_MAX_DURATION
    FILE_NAME: $ASSIGNMENT_VIDEO_NAME.mp4
  script:     
    # Get the file length in seconds
    - |
      # Extract duration in seconds using ffprobe
      DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 $FILE_NAME)
      # Round to nearest integer if needed
      DURATION_INT=$(printf "%.0f" $DURATION)
      echo "Video duration: $DURATION_INT seconds"
      
    # Check if duration is within the acceptable range
    - |
      if [ $DURATION_INT -lt $MIN_LENGTH ]; then
        echo "Error: Video is too short. Minimum length is $MIN_LENGTH seconds, but video is $DURATION_INT seconds."
        exit 1
      fi
      
      if [ $DURATION_INT -gt $MAX_LENGTH ]; then
        echo "Error: Video is too long. Maximum length is $MAX_LENGTH seconds, but video is $DURATION_INT seconds."
        exit 1
      fi
      
      echo "Video length check passed: $DURATION_INT seconds (required: between $MIN_LENGTH and $MAX_LENGTH seconds)"
  rules:
    - exists:
        - $ASSIGNMENT_VIDEO_NAME.mp4
  allow_failure: true

check_video_resolution:
  stage: comp3900-video
  tags:
    - comp4350
  image: 
    name: jrottenberg/ffmpeg:7.1-alpine
    entrypoint: [""] 
  variables:
    FILE_NAME: $ASSIGNMENT_VIDEO_NAME.mp4 
    MAX_WIDTH: 1920
    MAX_HEIGHT: 1080
  script:
    # Get the video resolution
    - |
      WIDTH=$(ffprobe -v error -select_streams v:0 -show_entries stream=width -of default=noprint_wrappers=1:nokey=1 $FILE_NAME)
      HEIGHT=$(ffprobe -v error -select_streams v:0 -show_entries stream=height -of default=noprint_wrappers=1:nokey=1 $FILE_NAME)
      
    # Check if resolution is within the acceptable dimensions
    - |
      if [ $WIDTH -gt $MAX_WIDTH ]; then
        echo "Error: Video is too wide. Maximum width is $MAX_WIDTH, but video is $WIDTH pixels wide."
        exit 1
      fi
      
      if [ $HEIGHT -gt $MAX_HEIGHT ]; then
        echo "Error: Video is too tall. Maximum height is $MAX_HEIGHT, but video is $HEIGHT pixels tall."
        exit 1
      fi
      
      echo "Video resolution check passed: $WIDTH x $HEIGHT is not larger than $MAX_WIDTH x $MAX_HEIGHT"
  rules:
    - exists:
        - $ASSIGNMENT_VIDEO_NAME.mp4
  allow_failure: true

.word_count_template: &word_count
  image: alpine:3.21.2
  before_script:
    - |
      cat > /tmp/check_word_count.sh << 'EOF'
      #!/bin/sh
      
      min_words=$1
      max_words=$2
      shift 2  # Remove the first two arguments (min and max)
      total_words=0

      if [ $# -eq 0 ]; then
        echo "Error: No files specified"
        exit 1
      fi

      for file in "$@"; do
      
        if [ ! -f "$file" ]; then
            echo "Error: File $file not found"
            exit 1
        fi
        
        # Count words in markdown file, excluding:
        # 1. YAML frontmatter if present
        # 2. Content after "## References"
        # 3. Code blocks (content between triple backticks)
        # 4. characters that aren't alphabetic or whitespace
        word_count=$(awk '
          BEGIN { removed_frontmatter = 0 }
          NR == 1 && $0 == "---" { in_front = 1; next }
          in_front && $0 == "---" { in_front = 0; removed_frontmatter = 1; next }
          in_front { next }
          { print }
        ' "$file" |
        sed '/^## References/,$d' | 
        awk '
          BEGIN { in_code_block = 0 }
          /^```/ { in_code_block = !in_code_block; next }
          !in_code_block { print }
        ' |
        sed 's/[^[:alpha:][:space:]]//g' |
        wc -w)
      
        echo "Word count for $file: $word_count"
        total_words=$((total_words + word_count))
      done

      echo "Total word count across all files: $total_words"
      
      if [ $total_words -lt $min_words ]; then
          echo "Error: Word count ($total_words) is less than minimum required ($min_words)"
          exit 1
      elif [ $total_words -gt $max_words ]; then
          echo "Error: Word count ($total_words) exceeds maximum allowed ($max_words)"
          exit 1
      else
          echo "Success: Word count ($total_words) is within acceptable range ($min_words - $max_words)."
          exit 0
      fi
      EOF
    - chmod +x /tmp/check_word_count.sh

check_word_count:
  stage: comp3900-checks
  tags:
    - comp4350
  <<: *word_count
  script:
    - /tmp/check_word_count.sh $ASSIGNMENT_MIN_WORDS $ASSIGNMENT_MAX_WORDS $ASSIGNMENT_DOCUMENT_NAME.md
  allow_failure: false

check_markdown:
  stage: comp3900-checks
  tags:
    - comp4350
  image: node:18-alpine
  before_script:
    - npm install -g markdownlint-cli
    - |
      cat > .markdownlint.json << 'EOF'
      {
        "default": true,
        "MD013": false,
        "MD041": false
      }
      EOF
  script:
    - echo "ðŸ” Linting markdown document..."
    - echo ""
    - |
      if markdownlint $ASSIGNMENT_DOCUMENT_NAME.md; then
        echo "âœ… SUCCESS: Markdown document meets standards."
        echo "ðŸŽ‰ Great job! Your document meets the standards listed here: https://github.com/DavidAnson/markdownlint/blob/main/doc/Rules.md"
      else
        echo "âŒ FAILED: Markdown document does not meet standards"
        echo ""
        echo "ðŸ”§ Common fixes:"
        echo "   - Ensure headers follow proper hierarchy (# ## ### etc.)"
        echo "   - Add blank lines around headers, lists, and images"
        echo "   - Remove trailing whitespace"
        echo "   - Ensure lists are properly formatted"
        echo "   - Add blank line at end of file"
        echo ""
        echo "ðŸ“š For a detailed Markdown style guide, see:"
        echo "   https://www.markdownguide.org/basic-syntax/"
        echo "   Note that the rules for this checking script are documented here:"
        echo "   https://github.com/DavidAnson/markdownlint/blob/main/doc/Rules.md"
        exit 1
      fi
      echo "âœ… Document structure check passed"
  rules:
    - exists: 
      - '$ASSIGNMENT_DOCUMENT_NAME.md'
  allow_failure: false

build_pdf:
  stage: comp3900-build
  image:
    name: charlepm/pandoc-latex-libertine:0.3.0
    entrypoint: ["/bin/sh", "-c"]
  tags:
    - comp4350
  variables:
    INPUT_MARKDOWN: '$ASSIGNMENT_DOCUMENT_NAME.md'
    OUTPUT_PDF: '$CI_PROJECT_NAME-$CI_PROJECT_NAMESPACE-$ASSIGNMENT_DOCUMENT_NAME.pdf'
  script:
    - |
      cp */*.png . || true
    - |
      cp */*.PNG . || true
    - |
      cp */*.jpg . || true
    - |
      cp */*.JPG . || true
    - |
      cp */*.jpeg . || true
    - |
      cp */*.JPEG . || true
    - |
      pandoc \
      --standalone \
      --embed-resources \
      --metadata date="$(date '+%Y-%m-%d')" \
      --output=$OUTPUT_PDF \
      -V 'geometry: left=2.5cm,right=2.5cm,top=2.5cm,bottom=2.5cm' \
      -V 'papersize: a4' \
      -V 'pagestyle:headings' \
      -V 'fontfamily:libertine,sourcecodepro' \
      -V 'fontsize:11pt' \
      $INPUT_MARKDOWN
  artifacts:
    paths: 
      - $OUTPUT_PDF
  allow_failure: true
