<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" 
    crossorigin="anonymous">

    </head>
    <body>
        <div class="container">
            <h1> Food Detector </h1>
            <div class="row justify-content-center">
                <div class="col">
                    <div class="card">
                        <div class="card-body">
                            <video id="camerafeed" autoplay controls=""></video>
                            <canvas id="overlay" style="position:absolute; top:0; left:0;"></canvas>
                            <button id="saveBtn" class="btn btn-primary mt-3">Save Snapshot</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            const video = document.getElementById('camerafeed');
            const canvas = document.getElementById('overlay');
            const ctx = canvas.getContext('2d');
            navigator.mediaDevices.getUserMedia({ video: true })
            .then(function (stream) {
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    sendFrames();  // start sending frames to server
                };
            })
            .catch(function (error) {
                console.log('Camera access error:', error);
            });

            async function sendFrames() {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = video.videoWidth;
                tempCanvas.height = video.videoHeight;
                const tempCtx = tempCanvas.getContext('2d');

                tempCtx.drawImage(video, 0, 0);
                const blob = await new Promise(r => tempCanvas.toBlob(r, 'image/jpeg'));

                const formData = new FormData();
                formData.append('image', blob);

                fetch('/food_detector/detect/', { method: 'POST', body: formData })
                    .then(res => res.json())
                    .then(data => drawBoxes(data.detections))
                    .catch(err => console.error(err));

                setTimeout(sendFrames, 200);  // repeat every 200ms
            }

            function drawBoxes(detections) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'red';
                ctx.font = '16px Arial';
                ctx.fillStyle = 'red';

                detections.forEach(det => {
                    const [x1, y1, x2, y2] = det.bbox;
                    ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                    ctx.fillText(det.label, x1, y1 - 5);
                });
            }

            const saveBtn = document.getElementById('saveBtn');

        saveBtn.addEventListener('click', async () => {
            // Capture current frame
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(video, 0, 0);
            const blob = await new Promise(r => tempCanvas.toBlob(r, 'image/jpeg'));

            const formData = new FormData();
            formData.append('image', blob);

            // POST to Django 'save_snapshot' view
            fetch('/food_detector/save_snapshot/', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    // Redirect to a new page showing detected objects
                    window.location.href = `/food_detector/snapshot_result/?objects=${encodeURIComponent(JSON.stringify(data.detections))}`;
                })
                .catch(err => console.error(err));
        });

        </script>
    </body>
</html>